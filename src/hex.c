#include <fingera_libc/hex.h>
#include <stdio.h>

static const char HEX_STRING_LOWER[16] = {'0', '1', '2', '3', '4', '5',
                                          '6', '7', '8', '9', 'a', 'b',
                                          'c', 'd', 'e', 'f'};
static const char HEX_STRING_UPPER[16] = {'0', '1', '2', '3', '4', '5',
                                          '6', '7', '8', '9', 'A', 'B',
                                          'C', 'D', 'E', 'F'};

void fingera_to_hex(const void *buf, size_t buf_size, char *str, int upper) {
  unsigned char byte;
  unsigned char *bytes = (unsigned char *)buf;
  const char *hex_str = upper ? HEX_STRING_UPPER : HEX_STRING_LOWER;
  for (size_t i = 0; i < buf_size; i++) {
    byte = bytes[i];
    str[0] = hex_str[byte >> 4];
    str[1] = hex_str[byte & 0xF];
    str += 2;
  }
}

static const unsigned char HEX_MAP[256] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff,
};

size_t fingera_from_hex(const char *str, size_t str_len, void *buf) {
  unsigned char high, low;
  unsigned char *out = (unsigned char *)buf;
  str_len &= ~(size_t)1;  // 去掉不对齐的
  for (size_t i = 0; i < str_len; i += 2) {
    high = HEX_MAP[(unsigned char)str[i]];
    low = HEX_MAP[(unsigned char)str[i + 1]];
    if (high == 0xFF || low == 0xFF) break;
    *out++ = (high << 4) | low;
  }
  return out - (unsigned char *)buf;
}

void fingera_hex_dump(const void *buf, size_t buf_size, int upper) {
  unsigned char byte;
  unsigned char *bytes = (unsigned char *)buf;
  const char *hex_str = upper ? HEX_STRING_UPPER : HEX_STRING_LOWER;

  char str_cache[1024];
  size_t str_cache_len = 0;
#define WRITE_CACHE__(c) str_cache[str_cache_len++] = (c);

  for (size_t i = 0; i < buf_size; i++) {
    byte = bytes[i];

    if (i != 0) {
      if (i % 4 == 0) WRITE_CACHE__(' ');
      if (i % 8 == 0) WRITE_CACHE__(' ');
      if (i % 16 == 0) WRITE_CACHE__(' ');
      if (i % 32 == 0) WRITE_CACHE__('\n');
    }

    WRITE_CACHE__(hex_str[byte >> 4]);
    WRITE_CACHE__(hex_str[byte & 0xF]);

    if (str_cache_len > 1000) {
      fwrite(str_cache, str_cache_len, 1, stdout);
      str_cache_len = 0;
    }
  }
  WRITE_CACHE__('\n');
#undef WRITE_CACHE__

  if (str_cache_len > 0) {
    fwrite(str_cache, str_cache_len, 1, stdout);
  }
}
